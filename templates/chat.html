<!DOCTYPE html>
<html>
   <head>
       <link href="https://fonts.googleapis.com/css2?family=Sora:wght@500;700&display=swap" rel="stylesheet">

      <title>StockBot Chat</title>
      <link rel="stylesheet" href="/static/style.css">
   </head>
    <div class="chat-header">
       <img src="/static/lseg.png" alt="LSEG Logo">
       <span class="chat-title">Chatbot</span>
    </div>
      <div class="chat-container" id="chat-container">
         <div class="bot-message">
            <div class="bot-bubble">
               üëã Hello! Welcome to LSEG StockBot.<br>Select a stock exchange to begin.
            </div>
         </div>
         <div class="bot-message">
            <div class="bot-bubble">
               <div class="option-list">
                  <button onclick="sendAction('select_exchange', 'LSE')">London Stock Exchange</button>
                  <button onclick="sendAction('select_exchange', 'NYSE')">New York Stock Exchange</button>
                  <button onclick="sendAction('select_exchange', 'NASDAQ')">NASDAQ Stock Exchange</button>
               </div>
            </div>
         </div>
      </div>
      <script>
         async function sendAction(action, value, options = {}) {
            const container = document.getElementById("chat-container");

            if (!options.silentUserBubble) {
                const userBubble = document.createElement("div");
                userBubble.classList.add("user-message");
                userBubble.innerHTML = `<div class="user-bubble">${value}</div>`;
                container.appendChild(userBubble);
                container.scrollTop = container.scrollHeight;
            }

             // Fetch response from server
             const formData = new FormData();
             formData.append("action", action);
             formData.append("value", value);

             const response = await fetch("/chat", {
                 method: "POST",
                 body: formData
             });

             const data = await response.json();

             const botMessage = document.createElement("div");
             botMessage.classList.add("bot-message");
             const botBubble = document.createElement("div");
             botBubble.classList.add("bot-bubble");

             if (data.type === "stock_list") {
                 botBubble.innerHTML = `<p>üìà Here are the top 5 stocks on <strong>${data.exchange_name}</strong>:</p>`;
                 const list = document.createElement("div");
                 list.classList.add("option-list");
                 data.stocks.forEach(stock => {
                     const btn = document.createElement("button");
                     btn.textContent = stock.stockName;
                     btn.onclick = () => sendAction("select_stock", stock.code);
                     list.appendChild(btn);
                 });
                 botBubble.appendChild(list);
             } else if (data.type === "stock_price") {
                 botBubble.innerHTML = `
                     üí∞ <strong>${data.stock_name}</strong> is priced at <strong>${data.price}</strong>.<br>
                     <p>What would you like to do?</p>
                     <div class="option-list">
                         <button onclick="showHomeMenu()">üè† Main Menu</button>
                         <button onclick="goBackToStocks('${data.exchange_code}')">üîô Go Back</button>
                     </div>
                 `;
             } else {
                 botBubble.textContent = "Oops! Something went wrong.";
             }

             botMessage.appendChild(botBubble);
             container.appendChild(botMessage);
             container.scrollTop = container.scrollHeight;
         }
function showHomeMenu() {
    const container = document.getElementById("chat-container");

    // ‚úÖ Add user message bubble for "Main Menu"
    const userMessage = document.createElement("div");
    userMessage.classList.add("user-message");
    userMessage.innerHTML = `<div class="user-bubble">üè† Main Menu</div>`;
    container.appendChild(userMessage);

    // ‚úÖ Add spacer bot bubble to separate visually
    const spacerMessage = document.createElement("div");
    spacerMessage.classList.add("bot-message");
    const spacerBubble = document.createElement("div");
    spacerBubble.classList.add("bot-bubble");
    spacerBubble.style.visibility = "hidden";
    spacerBubble.style.padding = "10px";
    spacerBubble.innerHTML = "spacer";
    spacerMessage.appendChild(spacerBubble);
    container.appendChild(spacerMessage);

    // ‚úÖ Add bot response with exchange options
    const botMessage = document.createElement("div");
    botMessage.classList.add("bot-message");

    const botBubble = document.createElement("div");
    botBubble.classList.add("bot-bubble");
    botBubble.innerHTML = `
        üëã Back to main menu.<br>Please select a stock exchange.
        <div class="option-list">
            <button onclick="sendAction('select_exchange', 'LSE')">London Stock Exchange</button>
            <button onclick="sendAction('select_exchange', 'NYSE')">New York Stock Exchange</button>
            <button onclick="sendAction('select_exchange', 'NASDAQ')">NASDAQ Stock Exchange</button>
        </div>
    `;

    botMessage.appendChild(botBubble);
    container.appendChild(botMessage);

    container.scrollTop = container.scrollHeight;
}



         function goBackToStocks(exchangeCode) {
             const container = document.getElementById("chat-container");

             // User says "Back"
             const userMessage = document.createElement("div");
             userMessage.classList.add("user-message");
             userMessage.innerHTML = `<div class="user-bubble">üîô Back</div>`;
             container.appendChild(userMessage);

             sendAction("select_exchange", exchangeCode, {
                fromBack: true,
                silentUserBubble: true  // ‚¨ÖÔ∏è this prevents user bubble
            });
         }

      </script>
   </body>
</html>